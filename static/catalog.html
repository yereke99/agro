<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>–ê–ì–†–û –ö–ª—É–± ‚Äî –ö–∞—Ç–∞–ª–æ–≥</title>
  <style>
    :root{
      --bg:#f6f9f4;
      --ink:#0b1f0b;
      --muted:#6b806b;
      --brand:#19a461;
      --brand-2:#88c057;
      --danger:#e53935;
      --card:#ffffff;
      --border:#e7efe2;
      --shadow:0 10px 30px rgba(25,164,97,.15);
    }
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%;background:var(--bg);color:var(--ink)}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,system-ui,Arial,sans-serif;
      height:var(--tg-viewport-stable-height,100vh);
      min-height:var(--tg-viewport-stable-height,100vh);
      padding-top:calc(var(--tg-safe-area-inset-top,0px) + var(--tg-content-safe-area-inset-top,0px) + 15px);
      padding-bottom:calc(var(--tg-safe-area-inset-bottom,0px) + 12px);
    }
    .header{
      position:sticky; top:0; z-index:10;
      background:linear-gradient(180deg,#ffffff,#f3f8ef);
      border-bottom:1px solid var(--border);
      padding:10px 16px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      backdrop-filter:saturate(140%) blur(8px);
    }
    .title{font-weight:900;letter-spacing:.2px}
    .sub{font-size:12px;color:var(--muted)}
    .right{display:flex;align-items:center;gap:8px}
    .badge{padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;color:var(--brand);font-weight:800;font-size:12px}
    .filters{display:flex;gap:8px;overflow:auto;padding:10px 16px 8px}
    .pill{
      white-space:nowrap; padding:8px 14px; border-radius:999px; border:1px solid var(--border);
      background:#fff; font-weight:800; color:var(--ink);
    }
    .pill.active{background:var(--brand); color:#fff; border-color:var(--brand)}
    .search{padding:0 16px 12px}
    .search input{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border);
      background:#fff; outline:none;
    }
    .list{overflow:auto}
    .row{
      display:flex; gap:12px; padding:12px 16px; align-items:center;
      border-bottom:1px solid var(--border); background:#ffffffaa;
    }
    .pic{
      width:64px; height:64px; border-radius:12px; border:1px solid var(--border);
      display:flex; align-items:center; justify-content:center; background:#fff; font-size:28px; overflow:hidden;
    }
    .pic img{width:100%; height:100%; object-fit:cover; border-radius:12px}
    .info{flex:1}
    .name{font-weight:900}
    .muted{color:var(--muted); font-size:13px}
    .price{font-size:16px; font-weight:900}
    .unit{font-size:12px; color:var(--muted); margin-left:6px}
    .qty{display:flex; align-items:center; gap:8px; background:#fff; border:1px solid var(--border); padding:6px; border-radius:999px}
    .qty button{
      width:28px;height:28px;border-radius:50%;border:0;background:var(--brand);color:#fff;font-weight:900;cursor:pointer;
    }
    .qty span{min-width:18px; text-align:center; font-weight:800}
    .floating{
      position:fixed; left:16px; right:16px;
      bottom:calc(16px + var(--tg-safe-area-inset-bottom,0px));
      display:flex; gap:8px; z-index:50;
    }
    .pay{
      flex:1; padding:14px; border-radius:14px; border:0;
      background:linear-gradient(135deg,var(--brand),var(--brand-2));
      color:#fff; font-weight:900; box-shadow:var(--shadow); cursor:pointer;
    }
    .alert{
      margin:10px 16px 0; padding:12px 14px; border-radius:12px; border:1px dashed #ffd9a6;
      background:#fff9ed; color:#b26b00; font-weight:700; display:none;
    }
    .empty{padding:48px 16px; text-align:center; color:var(--muted)}
    ::-webkit-scrollbar{width:4px;height:4px}::-webkit-scrollbar-thumb{background:#cfe4cf;border-radius:2px}
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <header class="header">
    <div>
      <div class="title">–ö–∞—Ç–∞–ª–æ–≥</div>
      <div class="sub">–ê–ª—Ç—ã–Ω –û—Ä–¥–∞ ‚Äî –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã</div>
    </div>
    <div class="right">
      <div id="subBadge" class="badge">–ü—Ä–æ–≤–µ—Ä—è–µ–º‚Ä¶</div>
    </div>
  </header>

  <div class="filters" id="filters">
    <button class="pill active" data-cat="all">–í—Å–µ</button>
    <button class="pill" data-cat="vegetables">–û–≤–æ—â–∏</button>
    <button class="pill" data-cat="fruits">–§—Ä—É–∫—Ç—ã</button>
    <button class="pill" data-cat="greens">–ó–µ–ª–µ–Ω—å</button>
    <button class="pill" data-cat="promo">–ê–∫—Ü–∏–∏</button>
  </div>

  <div class="search">
    <input id="q" type="search" placeholder="–ü–æ–∏—Å–∫: –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å, –º–æ—Ä–∫–æ–≤—å, —è–±–ª–æ–∫–∏‚Ä¶" />
  </div>

  <div id="markupAlert" class="alert">–î–ª—è –Ω–µ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö —Ü–µ–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Å –Ω–∞—Ü–µ–Ω–∫–æ–π √ó1.5. –î–ª—è –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ ‚Äî –¥–µ—à–µ–≤–ª–µ –Ω–∞ 30‚Äì50%.</div>

  <main id="list" class="list" aria-live="polite"></main>

  <div class="floating">
    <button id="payBtn" class="pay" disabled>üõí –ö–æ—Ä–∑–∏–Ω–∞ ¬∑ 0 ‚Ç∏</button>
  </div>

<script>
  // Boot
  try{ Telegram.WebApp.ready(); Telegram.WebApp.expand(); }catch(_){}
  let telegramId = null;
  try{ telegramId = Telegram?.WebApp?.initDataUnsafe?.user?.id || null; }catch(_){}

  const listEl = document.getElementById('list');
  const qEl    = document.getElementById('q');
  const payBtn = document.getElementById('payBtn');
  const subBadge = document.getElementById('subBadge');
  const markupAlert = document.getElementById('markupAlert');
  const filtersEl = document.getElementById('filters');

  let isSubscribed = false;
  let products = [];       // [{id, name, emoji, unit, price, category, photo}]
  let cart = {};           // {productId: qty}
  let currentCat = 'all';

  // ===== Helpers =====
  function escapeHtml(s){ const d=document.createElement('div'); d.textContent=s??''; return d.innerHTML; }
  function escapeAttr(s){ return String(s??'').replace(/"/g,'&quot;'); }

  // Make absolute photo URL: supports "/uploads/..." from DB
  function photoURL(p){
    const raw = (p.photo || '').trim();
    if(!raw) return '';
    if(/^https?:\/\//i.test(raw)) return raw; // already absolute
    // build absolute from current origin (handles Telegram WebApp context)
    const base = window.location.origin.replace(/\/+$/,'');
    const path = raw.startsWith('/') ? raw : '/'+raw;
    return base + path;
  }

  // 1) Subscription status
  async function loadSub(){
    try{
      const q = telegramId ? `?telegram_id=${telegramId}` : '';
      const r = await fetch(`/api/user/subscription-status${q}`);
      const js = await r.json();
      isSubscribed = !!js.active;
      if(isSubscribed){
        subBadge.textContent = `–ê–∫—Ç–∏–≤–Ω–∞ –¥–æ ${js.until}`;
        subBadge.style.color = 'var(--brand)';
      }else{
        subBadge.textContent = '–ù–µ–∞–∫—Ç–∏–≤–Ω–∞';
        subBadge.style.color = '#c62828';
        markupAlert.style.display = 'block';
      }
    }catch(_){
      subBadge.textContent = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    }
  }

  // 2) Load products
  async function loadProducts(){
    // [{id, name, emoji, unit:"‚Ç∏/–∫–≥", price:120, category:"vegetables", photo:"/uploads/.."}]
    const r = await fetch('/api/products');
    const js = await r.json();
    products = Array.isArray(js) ? js : [];
    render();
  }

  function priceFor(p){
    const base = Number(p.price)||0;
    if(isSubscribed) return base;
    return Math.round(base * 1.5); // –Ω–∞—Ü–µ–Ω–∫–∞ –±–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏
  }

  function filtered(){
    let arr = products;
    if(currentCat!=='all') arr = arr.filter(x=>x.category===currentCat);
    const term = (qEl.value||'').trim().toLowerCase();
    if(term) arr = arr.filter(x =>
      (x.name||'').toLowerCase().includes(term)
      || (x.emoji||'').includes(term)
    );
    return arr;
  }

  function render(){
    const items = filtered();
    if(items.length===0){
      listEl.innerHTML = `<div class="empty">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ‚Ä¶</div>`;
      recalc();
      return;
    }
    listEl.innerHTML = items.map(p=>{
      const qty = cart[p.id]||0;

      const src = photoURL(p);
      const pic = src
        ? `<img src="${escapeAttr(src)}" alt="${escapeAttr(p.name||'')}" loading="lazy"
               onerror="this.onerror=null; this.remove(); this.closest('.pic').textContent='${(p.emoji||'üß∫').replace(/'/g,'&#39;')}';">`
        : (p.emoji || 'üß∫');

      return `
      <div class="row" data-id="${p.id}">
        <div class="pic">${pic}</div>
        <div class="info">
          <div class="name">${escapeHtml(p.name||'–¢–æ–≤–∞—Ä')}</div>
          <div class="muted">${labelCat(p.category)} ‚Ä¢ ${p.unit||'‚Ç∏/–∫–≥'}</div>
          <div class="price">${priceFor(p)} ‚Ç∏ <span class="unit">${p.unit||'‚Ç∏/–∫–≥'}</span></div>
        </div>
        <div class="qty">
          <button data-act="dec">‚àí</button>
          <span>${qty}</span>
          <button data-act="inc">+</button>
        </div>
      </div>`;
    }).join('');
    recalc();
  }

  function labelCat(c){
    switch(c){
      case 'vegetables': return '–û–≤–æ—â–∏';
      case 'fruits': return '–§—Ä—É–∫—Ç—ã';
      case 'greens': return '–ó–µ–ª–µ–Ω—å';
      case 'promo': return '–ê–∫—Ü–∏–∏';
      default: return '–î—Ä—É–≥–æ–µ';
    }
  }

  // qty controls (event delegation)
  listEl.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-act]');
    if(!btn) return;
    const row = e.target.closest('.row'); if(!row) return;
    const id = row.getAttribute('data-id');
    const act = btn.getAttribute('data-act');
    const span = row.querySelector('.qty span');
    let qty = cart[id]||0;
    qty = act==='inc' ? qty+1 : Math.max(0, qty-1);
    cart[id]=qty; if(qty===0) delete cart[id];
    span.textContent = qty;
    recalc();
  });

  function recalc(){
    const entries = Object.entries(cart);
    let sum = 0;
    for(const [id, q] of entries){
      const p = products.find(x=>String(x.id)===String(id));
      if(!p) continue;
      sum += priceFor(p) * q;
    }
    payBtn.disabled = entries.length===0;
    payBtn.textContent = `üõí –ö–æ—Ä–∑–∏–Ω–∞ ¬∑ ${sum} ‚Ç∏`;
  }

  // Search debounce
  let t; qEl.addEventListener('input', ()=>{
    clearTimeout(t); t = setTimeout(render, 200);
  });

  // Filters
  filtersEl.addEventListener('click', (e)=>{
    const b = e.target.closest('.pill'); if(!b) return;
    filtersEl.querySelectorAll('.pill').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    currentCat = b.getAttribute('data-cat');
    render();
  });

  // Pay (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞)
  payBtn.addEventListener('click', async ()=>{
    const items = Object.entries(cart).map(([id,qty])=>{
      const p = products.find(x=>String(x.id)===String(id));
      return p ? {product_id:id, name:p.name, qty, unit:p.unit, price:priceFor(p)} : null;
    }).filter(Boolean);

    const total = items.reduce((s,x)=>s + x.price*x.qty, 0);
    const ok = confirm(`–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑ –Ω–∞ —Å—É–º–º—É ${total} ‚Ç∏?`);
    if(!ok) return;

    await fetch('/api/orders/create',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({telegram_id:telegramId, items})
    });

    if(Telegram?.WebApp?.showAlert) Telegram.WebApp.showAlert('–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É. –û–∂–∏–¥–∞–π—Ç–µ —Å—á—ë—Ç Kaspi.');
    cart = {};
    render();
  });

  // Start
  (async function init(){
    await loadSub();
    await loadProducts();
  })();
</script>
</body>
</html>
