<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>–ê–ì–†–û –ö–ª—É–± –û–ø—Ç–æ–≤—ã—Ö –¶–µ–Ω ‚Äî –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</title>
  <style>
    :root{
      --bg:#f6f9f4;
      --card:#ffffff;
      --ink:#0b1f0b;
      --muted:#6b806b;
      --brand:#19a461;
      --brand-2:#88c057;
      --danger:#e53935;
      --border:#e7efe2;
      --shadow:0 10px 30px rgba(25,164,97,.15);
    }
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,system-ui,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
      height:var(--tg-viewport-stable-height,100vh);
      min-height:var(--tg-viewport-stable-height,100vh);
      padding-top:calc(var(--tg-safe-area-inset-top,0px) + var(--tg-content-safe-area-inset-top,0px) + 15px);
      padding-bottom:calc(var(--tg-safe-area-inset-bottom,0px) + 12px);
    }
    .wrap{
      min-height:100%;
      display:flex;flex-direction:column;gap:16px;
    }
    .hero{
      margin:0 16px;
      padding:20px 18px;
      background:linear-gradient(180deg,#ffffff,#f3f8ef);
      border:1px solid var(--border);
      border-radius:16px; box-shadow:var(--shadow);
      display:flex; align-items:center; gap:14px;
    }
    .hero-emoji{font-size:36px}
    .hero-title{font-weight:800;font-size:20px;letter-spacing:.2px}
    .hero-sub{color:var(--muted);font-size:14px;margin-top:4px;line-height:1.35}
    .grid{
      display:grid; gap:12px; margin:4px 16px 16px;
      grid-template-columns:1fr;
    }
    .btn{
      display:flex;align-items:center;gap:12px;
      padding:16px;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px; box-shadow:var(--shadow);
      text-decoration:none; color:var(--ink);
      font-weight:800; letter-spacing:.2px;
      transition:transform .12s ease;
    }
    .btn:active{transform:scale(.985)}
    .btn .ic{font-size:20px}
    .btn .right{
      margin-left:auto; color:#6c6c6c; font-weight:700;
    }
    .note{
      margin:0 16px 8px; color:var(--muted); font-size:13px;
    }
    .legal{
      margin:8px 16px 16px; color:#809380; font-size:12px; line-height:1.4;
    }
    .badge{
      display:inline-block; padding:2px 8px; border-radius:999px;
      background:rgba(25,164,97,.12); color:var(--brand); font-weight:800; font-size:12px;
      border:1px solid rgba(25,164,97,.22);
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<div class="wrap">
  <section class="hero">
    <div class="hero-emoji">ü•¶</div>
    <div>
      <div class="hero-title">–ê–ì–†–û –ö–ª—É–± –û–ø—Ç–æ–≤—ã—Ö –¶–µ–Ω</div>
      <div class="hero-sub">–û–ø—Ç–æ–≤—ã–µ —Ü–µ–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤. –°–≤–µ–∂–∏–µ –∑–∞–∫—É–ø–æ—á–Ω—ã–µ —Ü–µ–Ω—ã ‚Äú–ê–ª—Ç—ã–Ω –û—Ä–¥–∞‚Äù.</div>
    </div>
  </section>

  <p class="note">
    –°—Ç–∞—Ç—É—Å: <span id="subStatus" class="badge">–ü—Ä–æ–≤–µ—Ä—è–µ–º‚Ä¶</span>
  </p>

  <nav class="grid">
    <a class="btn" href="/catalog">
      <span class="ic">üì¶</span>
      <span>–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç</span>
      <span class="right">‚Ä∫</span>
    </a>
    <button class="btn" id="subscribeBtn" type="button">
      <span class="ic">üí≥</span>
      <span>–û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</span>
      <span class="right">3000 ‚Ç∏ / –º–µ—Å—è—Ü</span>
    </button>
    <button class="btn" id="storeBtn" type="button">
      <span class="ic">üè™</span>
      <span>–í—ã–±—Ä–∞—Ç—å –±–ª–∏–∂–∞–π—à–∏–π –º–∞–≥–∞–∑–∏–Ω</span>
      <span class="right">–°–∞–º–∞–ª-3 ‚Ä¢ –ê–∫—Å–∞–π ‚Ä¢ ‚Ä¶</span>
    </button>
  </nav>

  <p class="note">
    –ü—Ä–∏–º–µ—Ä —Ü–µ–Ω (–ê–ª—Ç—ã–Ω –û—Ä–¥–∞):<br>
    ü•î –ö–∞—Ä—Ç–æ—Ñ–µ–ª—å ‚Äì 120 ‚Ç∏/–∫–≥ ‚Ä¢ ü•ï –ú–æ—Ä–∫–æ–≤—å ‚Äì 140 ‚Ç∏/–∫–≥ ‚Ä¢ üçÖ –ü–æ–º–∏–¥–æ—Ä—ã ‚Äì 450 ‚Ç∏/–∫–≥ ‚Ä¢ üçé –Ø–±–ª–æ–∫–∏ ‚Äì 380 ‚Ç∏/–∫–≥
  </p>

  <div class="legal">
    –ï—Å–ª–∏ –≤—ã –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã, –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã —Ü–µ–Ω—ã —Å –Ω–∞—Ü–µ–Ω–∫–æ–π 1.5√ó –∏ –æ—Ç–º–µ—Ç–∫–æ–π
    ¬´–¥–ª—è –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ ‚Äî –¥–µ—à–µ–≤–ª–µ –Ω–∞ 30‚Äì50%¬ª.
  </div>
</div>

<script>
  (function initTG(){
    try{
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
    }catch(e){}
  })();

  let telegramId = null;
  try{
    telegramId = Telegram?.WebApp?.initDataUnsafe?.user?.id || null;
  }catch(e){}

  async function loadStatus(){
    const badge = document.getElementById('subStatus');
    try{
      const q = telegramId ? `?telegram_id=${telegramId}` : '';
      const res = await fetch(`/api/user/subscription-status${q}`);
      const js  = await res.json();

      if(js.active){
        badge.textContent = `–ê–∫—Ç–∏–≤–Ω–∞ –¥–æ ${js.until}`;
        badge.style.background = 'rgba(25,164,97,.12)';
        badge.style.color = 'var(--brand)';
      }else{
        badge.textContent = '–ù–µ–∞–∫—Ç–∏–≤–Ω–∞';
        badge.style.background = 'rgba(229,57,53,.10)';
        badge.style.color = '#c62828';
        badge.style.borderColor = 'rgba(229,57,53,.3)';
      }
    }catch(e){
      badge.textContent = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    }
  }
  loadStatus();

  document.getElementById('subscribeBtn').addEventListener('click', async ()=>{
    if(!telegramId){
      alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–∞—à Telegram ID.\n–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–∑ –±–æ—Ç–∞ –µ—â—ë —Ä–∞–∑.');
      return;
    }

    const ok = confirm(
      '–ü–æ–¥–ø–∏—Å–∫–∞ 3000 ‚Ç∏/–º–µ—Å.\n' +
      '–í—ã –ø–æ–ª—É—á–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –æ–ø—Ç–æ–≤—ã–º —Ü–µ–Ω–∞–º.\n\n' +
      '–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ Kaspi Pay.\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?'
    );
    if(!ok) return;

    const phone = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (Kaspi, —Ñ–æ—Ä–º–∞—Ç–∞ +7 ...):');
    if(!phone) return;

    await fetch('/api/subscribe/request-invoice', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({telegram_id: String(telegramId), phone})
    });

    if (Telegram?.WebApp?.showAlert){
      Telegram.WebApp.showAlert(
        '–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É –ø–æ–¥–ø–∏—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤–∞–º –≤ Telegram.\n' +
        '–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏—à–ª–∏—Ç–µ —á–µ–∫ –±–æ—Ç—É.'
      );
    } else {
      alert(
        '–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É –ø–æ–¥–ø–∏—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤–∞–º –≤ Telegram.\n' +
        '–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏—à–ª–∏—Ç–µ —á–µ–∫ –±–æ—Ç—É.'
      );
    }
  });

  document.getElementById('storeBtn').addEventListener('click', async ()=>{
    if(!telegramId){
      alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–∞—à Telegram ID.\n–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–∑ –±–æ—Ç–∞ –µ—â—ë —Ä–∞–∑.');
      return;
    }
    const store = prompt('–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω: –°–∞–º–∞–ª-3 / –ê–∫—Å–∞–π / –°–∞–π—Ä–∞–Ω / –ê–ª–≥–∞–±–∞—Å / –¢–∞—É–≥—É–ª—å');
    if(!store) return;
    await fetch('/api/user/set-store', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({telegram_id: String(telegramId), store})
    });
    if (Telegram?.WebApp?.showAlert){
      Telegram.WebApp.showAlert('–ú–∞–≥–∞–∑–∏–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –ø—Ä–æ—Ñ–∏–ª–µ.');
    } else {
      alert('–ú–∞–≥–∞–∑–∏–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω.');
    }
  });
</script>
</body>
</html>
